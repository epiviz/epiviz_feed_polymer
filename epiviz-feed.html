<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import"
      href="bower_components/promise-polyfill/promise-polyfill-lite.html">
<link rel="import" href="bower_components/iron-list/iron-list.html">
<link rel="import" href="bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="bower_components/paper-search/paper-search-bar.html">
<link rel="import" href="bower_components/paper-search/paper-search-panel.html">

<dom-module id="epiviz-feed">
    <template>
        <style>
            :host {
                display: inline-block;
            }

            iron-list {
                height: 500px;
                /* don't use % values unless the parent element is sized. */
            }

            .feed-pane-container {
                /*float: right;*/
                position: fixed;
                z-index: 100;
                right: 0;
                background: #f0f8ff;
                height: 600px;
            }

            .pane.feed-pane {
                width: 400px;
                padding: 20px;
                flex-shrink: 0;
                /*position: absolute;*/
                /*z-index: 10;*/
            }

            .pane.feed-pane:hover {
                height: 100%;
            }

            .pane.feed-pane h2 {
                color: #38425D;
                font-size: 16px;
                line-height: 20px;
                font-weight: 700;
                margin: 0 0 10px;
                display: block;
                -webkit-margin-before: 0.83em;
                -webkit-margin-after: 0.83em;
                -webkit-margin-start: 0;
                -webkit-margin-end: 0;
            }

            .pane.feed-pane h3 {
                font-size: 14px;
                display: block;
                -webkit-margin-before: 0em;
                -webkit-margin-after: 0em;
                -webkit-margin-start: 0px;
                -webkit-margin-end: 0px;
                font-weight: 400;
            }

            .open-sans-font {
                font-family: 'Open Sans', sans-serif;
            }

            .feed-header {

            }

            .feed-content {
                font-size: 12px;
                line-height: 18px;
                cursor: pointer;
            }

            .feed-element-container {
                border-style: groove;
                cursor: pointer;
            }

            .feed-show-hide {
                position: fixed;
                right: 30px;
                top: 20px;
                font-size: 18px;
                z-index: 1000;
            }
        </style>
        <iron-ajax id="requestResults"
                   auto
                   url="http://localhost:5001/chr=11&start=3947953&end=7164951"
                   params=''
                   handle-as="json"
                   on-response="handleResponse"
                   debounce-duration="300">
        </iron-ajax>
        <button id='show-hide-toggle' class="feed-show-hide"
                on-click="showHideClick">Hide
        </button>
        <div id="feed-container" class="feed-pane-container">
            <div class="pane feed-pane">
                <div class="feed-header open-sans-font">
                    <h2>Feed Views</h2>
                    <paper-search-panel
                            search="{{searchString}}"
                            count="5"
                            items="{{results}}"
                            has-more="[[hasMore]]"
                            filters="null"
                            selected-filters=""
                            loading="[[loading]]"
                            on-search="searchQuery"
                            on-search-changed="searchQuery"
                            >
                        <!--<div>-->
                        <!--Show your [[count]] results for "[[search]]"-->
                        <!--</div>-->
                    </paper-search-panel>
                    <!--<paper-search-bar query="{{query}}"-->
                    <!--placeholder="Enter search term"-->
                    <!--nr-selected-filters="3"-->
                    <!--on-paper-search-search="search"></paper-search-bar>-->
                </div>
                <iron-list items="[[filteredResults]]" as="result"
                           selection-enabled=true selected-as="selectedItem"
                           on-selected-item-changed="selectionChanged">
                    <template>
                        <!--<div class="feed-content">-->
                        <div
                                class="feed-element-container">

                            <h3>[[result.description]]</h3>
                        </div>
                        <!--</div>-->
                    </template>
                </iron-list>
            </div>
        </div>
        <epiviz-navigation id="epiviz_env"
                           chr="chr11"
                           start=3947953
                           end=7164991>
        </epiviz-navigation>

    </template>
    <script>
        Polymer({
            is: 'epiviz-feed',
            properties: {
                results: {
                    type: Array
                },
                filteredResults: {
                    type: Array
                },
                selectedItem: {
                    type: Object,
                    notify: true
                },
                searchString: {
                    type: String
                }
            },

            ready: function () {
                this.$.requestResults.generateRequest();
                this.notMethy = true;
            },
            handleResponse: function (data) {
                this.results = data.detail.response;
                this.filteredResults = this.results;
                if (this.results != null) {
                    getDescription(this.results);
                }
            },

            selectionChanged: function (e, value) {
//                console.log(e);
                console.log(value);
                if (value != null && value.value != null)
                    this.clicked(value.value);
            },
            clicked: function (result) {
                var test_measure = result['data-source'];
                // methylation charts should be customized.
                if ((result['data-type-one'] == 'methylation' &&
                        result['data-type-two'] == 'expression' ) ||
                        (result['data-type-one'] == 'expression' &&
                        result['data-type-two'] == 'methylation')) {
                    var dims = [result['data-type-one'] + '_' +
                    result['attribute-one'],
                        result['data-type-two'] + '_'
                        + result['attribute-two']];
//                    var key = ["exp_diff", "methy_diff"];
                    var data = result['data'];
//                    var element =
//                            document.createElement('epiviz-json-scatter-plot');
                    var customScatterPlot =
                            "<epiviz-json-scatter-plot dim-s='" +
                            JSON.stringify(dims) +
//                            "' key='" +
//                                    JSON.stringify(key) +
                            "' data='" +
                            JSON.stringify(data) +
                            "'></epiviz-json-scatter-plot>";
                    customScatterPlot.chartSettings.title = result['title'];
                    $("#epiviz_env").append(customScatterPlot);
//                    Polymer.dom(document.querySelector("#epiviz_env")).appendChild(element);

                }
                // two block data, add a block overlapping track
                else if (result['data-type-one'] == 'block' &&
                        result['data-type-two'] == 'block') {
                    test_measure[0]['type'] = 'range';
                    test_measure[1]['type'] = 'range';
                    test_measure[0]['metadata'] = null;
                    test_measure[1]['metadata'] = null;
                    var block_element =
                            document.createElement('epiviz-blocks-track');
                    block_element.setAttribute('measurements',
                            JSON.stringify(test_measure));
                    block_element.chartSettings.title = result['title'];

                    block_element.className = 'charts';

                    Polymer.dom(document.querySelector("#epiviz_env")).appendChild(block_element);
                }
                else {
                    var element = document.createElement('epiviz-scatter-plot');
                    element.setAttribute('measurements',
                            JSON.stringify(test_measure));
                    element.chartSettings.title = result['title'];
                    element.className = 'charts';

                    Polymer.dom(document.querySelector("#epiviz_env")).appendChild(element);
                }
            },
            showHideClick: function () {
                var element = document.getElementById('show-hide-toggle');
                var feed_element = document.getElementById('feed-container');
                if (element.textContent.trim() == "Hide") {
                    element.textContent = "Show";
                    feed_element.style.display = 'none';
                } else {
                    element.textContent = "Hide";
                    feed_element.style.display = 'block';
                }
            },
            searchQuery: function () {
                console.log("search executed!");
                if (this.searchString != undefined && this.searchString != null
                        && this.searchString != "") {
                    var query = this.searchString;
                    var filtered = this.results.filter(function (result) {
                        // Array.prototype.filter
                        if (result['attribute-one'].includes(query) ||
                                result['attribute-two'].includes(query) ||
                                result['computation-type'].includes(query) ||
                                result['data-type-one'].includes(query) ||
                                result['data-type-two'].includes(query)) {
                            return result;
                        }
                    });
                     this.filteredResults = filtered;
                } else {
                    this.filteredResults = this.results;
                }
            }
        });

        function getDescription(results) {
            results.forEach(function (result) {
                // get description
                result['description'] = result['computation-type'] +
                        ' between ' + result['data-type-one'] + ' ' +
                        result['attribute-one'] + ' and ' +
                        result['data-type-two'] + ' ' +
                        result['attribute-two'] + ' is ' +
                        result['value'].toFixed(2) + '.';
                // get title
                result['title'] = result['computation-type'] +
                        ' between ' + result['data-type-one'] + ' ' +
                        result['attribute-one'] + ' and ' +
                        result['data-type-two'] + ' ' +
                        result['attribute-two'];
            });
        }

    </script>
</dom-module>