<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import"
      href="bower_components/epiviz-data-source/epiviz-data-source.html">
<link rel="import" href="bower_components/epiviz-charts/epiviz-charts.html">
<link rel="import"
      href="bower_components/promise-polyfill/promise-polyfill-lite.html">
<link rel="import" href="bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="bower_components/paper-search/paper-search-panel.html">
<link rel="import" href="bower_components/iron-collapse/iron-collapse.html">
<link rel="import"
      href="bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="bower_components/paper-item/paper-item.html">
<link rel="import" href="bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="bower_components/iron-icons/iron-icons.html">

<link rel="import" href="bower_components/paper-spinner/paper-spinner.html">
<link rel="import"
      href="bower_components/paper-spinner/paper-spinner-lite.html">

<link rel="import" href="bower_components/paper-card/paper-card.html">

<link rel="import" href="bower_components/web-socket/web-socket.html">

<!--<link rel="import"-->
<!--href="bower_components/app-layout/app-drawer/app-drawer.html">-->
<!--<link rel="import"-->
<!--href="bower_components/app-layout/app-header/app-header.html">-->

<link rel="import" href="bower_components/app-layout/app-layout.html">

<link rel="import"
      href="bower_components/paper-icon-button/paper-icon-button.html">

<dom-module id="epiviz-feed">
    <template>
        <style>
            :host {
                /*display: inline-block;*/
                --app-drawer-width: 440px;
            }

            /*epiviz-navigation {*/
                /*width: 65%;*/
            /*}*/

            .show-hide-button {
                padding: 10px;
                background-color: #f3f3f3;
                border: 1px solid #dedede;
                border-radius: 5px;
                font-size: 16px;
                cursor: pointer;
                -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
                text-align: center;
                display: block;
            }

            :host([opened]) #trigger {
                border-bottom-left-radius: 0;
                border-bottom-right-radius: 0;
            }

            paper-card {
                margin: 3px;
                padding: 5px;
                border-radius: 5px;
                /*cursor: pointer;*/
            }

            .click-to-add, .hover-over-attribute {
                cursor: pointer;
            }

            .feed-pane-container {
                /*float: right;*/
                /*position: fixed;*/
                z-index: auto;
                /*right: 0;*/
                text-align: initial;
                background: #e6ecf0;
                margin-top: 48px;
                height: calc(100% - 48px);
            }

            .pane.feed-pane {
                /*width: 400px;*/
                padding: 5px;
                flex-shrink: 0;
                /*position: absolute;*/
                /*z-index: 10;*/
            }

            .pane.feed-pane:hover {
                height: 100%;
            }

            .pane.feed-pane h2 {
                color: #38425D;
                font-size: 16px;
                line-height: 20px;
                font-weight: 700;
                margin: 0 0 10px;
                display: block;
                /*-webkit-margin-before: 0.83em;*/
                /*-webkit-margin-after: 0.83em;*/
                -webkit-margin-start: 0;
                -webkit-margin-end: 0;
            }

            .pane.feed-pane h3 {
                font-size: 14px;
                display: inline;
                -webkit-margin-before: 0em;
                -webkit-margin-after: 0em;
                -webkit-margin-start: 0px;
                -webkit-margin-end: 0px;
                font-weight: normal;
            }

            .open-sans-font {
                font-family: 'Open Sans', sans-serif;
            }

            .arial-sans-font {
                font-family: "Segoe UI", Arial, sans-serif;
            }

            .feed-content {
                font-size: 12px;
                line-height: 18px;
                cursor: pointer;
            }

            .feed-element-container {
                background-color: #fff;
                /*border-style: groove;*/
                cursor: pointer;
                border-bottom: 2px solid #e6ecf0;
                padding: 3px;
            }

            .feed-element-container.selected {
                outline: 0;
                background-color: #ddd;
            }

            .feed-show-hide {
                position: fixed;
                right: 10px;
                top: 10px;
                z-index: 150;
            }

            #feed-header {
                height: 130px;
            }

            .grouped-list {
                padding: 15px;
                border: 1px solid #dedede;
            }

            .group-dropdown-menu {
                max-width: 160px;
            }

            .overflow-y {
                overflow-y: scroll;
            }

            #feed-results {
                height: 75%;
            }

            app-drawer {
                --app-drawer-scrim-background: none;
                --app-drawer-content-container: {
                    background-color: #e6ecf0;
                }
            }

            app-header {
                /*position: fixed;*/
                top: 0;
                left: 0;
                width: 100%;
                background-color: #e0e2e2;
                /*--app-header-background-front-layer: {*/
                    /*background-color: red;*/
                /*};*/
                /*--app-header-background-rear-layer: {*/
                    /*background-color: blue;*/
                /*};*/
            }

            .header-bar-height {
                height: 50px;
            }

            paper-search-panel {
                margin: 5px;
            }

            paper-spinner-lite {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translateX(-50%) translateY(-50%);
                height: 75px;
                width: 75px;
            }

        </style>
        <web-socket id="requestResults"
                    url="ws://localhost:5001/getdata"
                    on-message="handleResponse"
                    on-open="socketOpen">
            <!--on-error="showError"-->
            <!--on-close="endSocket"-->
        </web-socket>
        <!--<paper-button raised id='show-hide-toggle'-->
        <!--class="feed-show-hide show-hide-button"-->
        <!--on-click="showHideClick">Hide-->
        <!--</paper-button>-->
        <app-header-layout fullbleed>
        <app-header class="header-bar-height" fixed>
            <app-toolbar class="header-bar-height">
                <div main-title>Epiviz Compute</div>
                <div right>Feed</div>
                <paper-icon-button icon="menu"
                                   on-click="drawerToggleClicked"></paper-icon-button>
            </app-toolbar>
            <!--<app-toolbar class="tall">-->
            <!--<h1 main-title>What is material?</h1>-->
            <!--</app-toolbar>-->
        </app-header>

        <app-drawer-layout id="feed-drawer-layout">

        <epiviz-navigation id="epiviz_env"
                           chr="{{chr}}"
                           start="{{start}}"
                           end="{{end}}"
                           no-logo>
            <!--<epiviz-json-scatter-plot class="charts" id="WLs"-->
            <!--dim-s="[&quot;expression_lung___normal&quot;,&quot;methylation_thyroid&quot;]" data="[{&quot;expression_lung___normal&quot;:0,&quot;methylation_thyroid&quot;:0.031022222222222222},{&quot;expression_lung___normal&quot;:0,&quot;methylation_thyroid&quot;:0.0021166666666666656},{&quot;expression_lung___normal&quot;:1,&quot;methylation_thyroid&quot;:0.0021166666666666656},{&quot;expression_lung___normal&quot;:0,&quot;methylation_thyroid&quot;:0.022628571428571425},{&quot;expression_lung___normal&quot;:0,&quot;methylation_thyroid&quot;:-0.033350000000000005},{&quot;expression_lung___normal&quot;:0,&quot;methylation_thyroid&quot;:-0.027325000000000002},{&quot;expression_lung___normal&quot;:0,&quot;methylation_thyroid&quot;:0.00726},{&quot;expression_lung___normal&quot;:0,&quot;methylation_thyroid&quot;:-0.02318},{&quot;expression_lung___normal&quot;:0,&quot;methylation_thyroid&quot;:-0.011949999999999997},{&quot;expression_lung___normal&quot;:0,&quot;methylation_thyroid&quot;:-0.011949999999999997},{&quot;expression_lung___normal&quot;:0,&quot;methylation_thyroid&quot;:-0.011949999999999997},{&quot;expression_lung___normal&quot;:0,&quot;methylation_thyroid&quot;:-0.02835909090909091},{&quot;expression_lung___normal&quot;:0,&quot;methylation_thyroid&quot;:-0.024399999999999998},{&quot;expression_lung___normal&quot;:1,&quot;methylation_thyroid&quot;:-0.02125},{&quot;expression_lung___normal&quot;:1,&quot;methylation_thyroid&quot;:-0.02125},{&quot;expression_lung___normal&quot;:1,&quot;methylation_thyroid&quot;:-0.02125},{&quot;expression_lung___normal&quot;:0.3333333333,&quot;methylation_thyroid&quot;:-0.0724},{&quot;expression_lung___normal&quot;:0.6666666667,&quot;methylation_thyroid&quot;:-0.0992},{&quot;expression_lung___normal&quot;:0.6666666667,&quot;methylation_thyroid&quot;:-0.0992},{&quot;expression_lung___normal&quot;:0.6666666667,&quot;methylation_thyroid&quot;:-0.0992},{&quot;expression_lung___normal&quot;:0,&quot;methylation_thyroid&quot;:-0.027016666666666665},{&quot;expression_lung___normal&quot;:0,&quot;methylation_thyroid&quot;:-0.055850000000000004},{&quot;expression_lung___normal&quot;:0,&quot;methylation_thyroid&quot;:-0.07255},{&quot;expression_lung___normal&quot;:0,&quot;methylation_thyroid&quot;:-0.0666},{&quot;expression_lung___normal&quot;:0,&quot;methylation_thyroid&quot;:-0.0666},{&quot;expression_lung___normal&quot;:0,&quot;methylation_thyroid&quot;:-0.0343},{&quot;expression_lung___normal&quot;:0,&quot;methylation_thyroid&quot;:-0.01235},{&quot;expression_lung___normal&quot;:0,&quot;methylation_thyroid&quot;:-0.0652},{&quot;expression_lung___normal&quot;:0,&quot;methylation_thyroid&quot;:-0.02615},{&quot;expression_lung___normal&quot;:0,&quot;methylation_thyroid&quot;:-0.0036000000000000003},{&quot;expression_lung___normal&quot;:0,&quot;methylation_thyroid&quot;:-0.01458},{&quot;expression_lung___normal&quot;:0,&quot;methylation_thyroid&quot;:0.0013000000000000002},{&quot;expression_lung___normal&quot;:0,&quot;methylation_thyroid&quot;:-0.04228333333333333},{&quot;expression_lung___normal&quot;:0,&quot;methylation_thyroid&quot;:-0.01774},{&quot;expression_lung___normal&quot;:0,&quot;methylation_thyroid&quot;:-0.01774},{&quot;expression_lung___normal&quot;:0,&quot;methylation_thyroid&quot;:-0.004960000000000001},{&quot;expression_lung___normal&quot;:0,&quot;methylation_thyroid&quot;:-0.004960000000000001},{&quot;expression_lung___normal&quot;:1,&quot;methylation_thyroid&quot;:-0.0101},{&quot;expression_lung___normal&quot;:0,&quot;methylation_thyroid&quot;:-0.0021666666666666666},{&quot;expression_lung___normal&quot;:0,&quot;methylation_thyroid&quot;:0.0029000000000000002},{&quot;expression_lung___normal&quot;:0,&quot;methylation_thyroid&quot;:-0.021239999999999995},{&quot;expression_lung___normal&quot;:0,&quot;methylation_thyroid&quot;:0.017089999999999998},{&quot;expression_lung___normal&quot;:1,&quot;methylation_thyroid&quot;:0.037375},{&quot;expression_lung___normal&quot;:0,&quot;methylation_thyroid&quot;:0.030516666666666664},{&quot;expression_lung___normal&quot;:0,&quot;methylation_thyroid&quot;:0.030516666666666664},{&quot;expression_lung___normal&quot;:0.3333333333,&quot;methylation_thyroid&quot;:0.01052},{&quot;expression_lung___normal&quot;:0,&quot;methylation_thyroid&quot;:0.0038},{&quot;expression_lung___normal&quot;:0,&quot;methylation_thyroid&quot;:0.0038},{&quot;expression_lung___normal&quot;:0,&quot;methylation_thyroid&quot;:-0.00518},{&quot;expression_lung___normal&quot;:0,&quot;methylation_thyroid&quot;:-0.00518},{&quot;expression_lung___normal&quot;:0,&quot;methylation_thyroid&quot;:-0.00518},{&quot;expression_lung___normal&quot;:0,&quot;methylation_thyroid&quot;:-0.00518},{&quot;expression_lung___normal&quot;:1,&quot;methylation_thyroid&quot;:-0.010575},{&quot;expression_lung___normal&quot;:0,&quot;methylation_thyroid&quot;:-0.0264},{&quot;expression_lung___normal&quot;:0,&quot;methylation_thyroid&quot;:-0.0264},{&quot;expression_lung___normal&quot;:0,&quot;methylation_thyroid&quot;:0.023725000000000003},{&quot;expression_lung___normal&quot;:0,&quot;methylation_thyroid&quot;:0.024255555555555555},{&quot;expression_lung___normal&quot;:0,&quot;methylation_thyroid&quot;:0.024255555555555555},{&quot;expression_lung___normal&quot;:0,&quot;methylation_thyroid&quot;:0.0021999999999999997},{&quot;expression_lung___normal&quot;:0,&quot;methylation_thyroid&quot;:0.0021999999999999997},{&quot;expression_lung___normal&quot;:1,&quot;methylation_thyroid&quot;:0.009224999999999999},{&quot;expression_lung___normal&quot;:1,&quot;methylation_thyroid&quot;:0.0011250000000000001},{&quot;expression_lung___normal&quot;:1,&quot;methylation_thyroid&quot;:0.0011250000000000001},{&quot;expression_lung___normal&quot;:1,&quot;methylation_thyroid&quot;:-0.0064333333333333334},{&quot;expression_lung___normal&quot;:0,&quot;methylation_thyroid&quot;:-0.0064333333333333334},{&quot;expression_lung___normal&quot;:0,&quot;methylation_thyroid&quot;:0.02928666666666667},{&quot;expression_lung___normal&quot;:1,&quot;methylation_thyroid&quot;:0.02928666666666667},{&quot;expression_lung___normal&quot;:0.3333333333,&quot;methylation_thyroid&quot;:-0.005625},{&quot;expression_lung___normal&quot;:0,&quot;methylation_thyroid&quot;:-0.0006999999999999992},{&quot;expression_lung___normal&quot;:0,&quot;methylation_thyroid&quot;:-0.025333333333333333},{&quot;expression_lung___normal&quot;:0,&quot;methylation_thyroid&quot;:-0.0065875000000000005},{&quot;expression_lung___normal&quot;:0,&quot;methylation_thyroid&quot;:-0.010366666666666668},{&quot;expression_lung___normal&quot;:0,&quot;methylation_thyroid&quot;:-0.010366666666666668},{&quot;expression_lung___normal&quot;:0,&quot;methylation_thyroid&quot;:-0.02114285714285714},{&quot;expression_lung___normal&quot;:0,&quot;methylation_thyroid&quot;:0.004633333333333332}]">-->
            <!--</epiviz-json-scatter-plot>-->
        </epiviz-navigation>

        <app-drawer id="drawer" align="right" swipe-open>
            <div id="feed-container" class="feed-pane-container">
                <div class="pane feed-pane">
                    <div class="feed-header arial-sans-font">
                        <h2>
                            <iron-icon icon="icons:trending-up"></iron-icon>
                            Feed Results
                            <paper-dropdown-menu class="group-dropdown-menu"
                                                 label="GroupBy">
                                <paper-listbox class="dropdown-content"
                                               selected="{{groupByMethod}}"
                                               attr-for-selected="label"
                                               on-selected-item-changed="groupByChanged">
                                    <paper-item label="All Types">All
                                        Types
                                    </paper-item>
                                    <!--<paper-item label="Tissue Type">Tissue-->
                                    <!--Type-->
                                    <!--</paper-item>-->
                                    <paper-item
                                            label="Computation Type">Computation
                                        Type
                                    </paper-item>
                                    <paper-item label="Data Type">Data
                                        Type
                                    </paper-item>
                                </paper-listbox>
                            </paper-dropdown-menu>
                        </h2>
                        <paper-search-panel
                                search="{{searchString}}"
                                count="5"
                                items="{{results}}"
                                hide-filter-button="True"
                                on-search="searchQuery"
                                no-results-text=""
                                on-search-changed="searchQuery">
                        </paper-search-panel>
                    </div>
                    <div id="feed-results" class="overflow-y">
                        <paper-spinner-lite active
                                            class="blue"
                                            hidden$="[[_hideSpinner]]">

                        </paper-spinner-lite>
                        <template is="dom-repeat"
                                  items="{{filteredResultsByType}}">
                            <paper-button id="trigger trigger-[[item.type]]"
                                          class="show-hide-button"
                                          on-click="groupToggle"
                                          aria-expanded$="[[opened]]">
                                <iron-icon icon="icons:menu"></iron-icon>
                                [[item.type]]
                            </paper-button>
                            <iron-collapse id="collapse-[[item.type]]"
                                           opened="opened">
                                <div class="grouped-list">
                                    <template is="dom-repeat"
                                              items="{{item.list}}"
                                              as="feedItem">
                                        <paper-card>
                                                <iron-icon on-tap="itemTapped"
                                                           class="click-to-add"
                                                        icon="image:add-to-photos">
                                                </iron-icon>

                                            <h3>The [[feedItem.computation-type]]
                                                between [[feedItem.data-type-one]]
                                                <a class="hover-over-attribute"
                                                        on-tap="attributeTapped">[[feedItem.attribute-one]]</a>
                                                and
                                                [[feedItem.data-type-two]]
                                                <a class="hover-over-attribute"
                                                        on-tap="attributeTapped">[[feedItem.attribute-two]]</a>
                                                is
                                                <b>[[feedItem.value]]</b>. The
                                                p-value is
                                                <i>[[feedItem.pvalue]]</i>.
                                            </h3>

                                        </paper-card>
                                    </template>
                                </div>
                            </iron-collapse>
                        </template>
                    </div>

                    <!--<simple-iron-collapse class="pane feed-pane arial-sans-font"-->
                    <!--filtered-results="{{filteredResults}}"-->
                    <!--opened="[[opened]]"-->
                    <!--search-string="[[searchString]]"></simple-iron-collapse>-->

                </div>
            </div>
        </app-drawer>
        </app-drawer-layout>
        </app-header-layout>


    </template>
    <script>
        Polymer({
            is: 'epiviz-feed',
            properties: {
                results: {
                    type: Array,
                    value: []
                },
                filteredResults: {
                    type: Object,
                    value: {},
                    notify: true
                },
                filteredResultsByType: {
                    type: Array,
                    notify: true
                },
                selectedItem: {
                    type: Object,
                    notify: true
                },
                selectItem: {
                    type: Object,
                    notify: true
                },
                groupByMethod: {
                    type: String,
                    value: "All Types",
                    notify: true
                },
                searchString: {
                    type: String
                },
                opened: {
                    type: Boolean,
                    reflectToAttribute: true
                },
                chr: {
                    type: String,
                    value: "chr11",
                    notify: true
                },
                start: {
                    type: Number,
                    value: 3947153,
                    notify: true
                },
                end: {
                    type: Number,
                    value: 7164991,
                    notify: true
                },
                seqID: {
                    type: Number,
                    value: 0
                },
                webSocketReady: {
                    type: Boolean,
                    value: false
                },
                webSocketCounter: {
                    type: Number,
                    value: 0
                },
                _hideSpinner: {
                    type: Boolean,
                    value: false,
                    notify: true
                }
            },

            observers: [
                '_rangeChanged(chr, start, end)'
            ],

            listeners: {
                'epiviz-chart-deleted': 'chartDeleted'
            },


            _rangeChanged: function (chr, start, end) {
                this.filteredResultsByType = [];
                this.set("_hideSpinner", false);
                var seqData = {
                    start: this.start,
                    end: this.end,
                    chr: this.chr
                };

                // increase the counter to deal with multiple requests
                if (this.seqID == null) {
                    this.seqID = 0;
                } else {
                    this.seqID += 1;
                }

                var msgToSend = {
                    seq: this.seqID,
                    data: seqData
                };

                // web sockets
                if (this.webSocketReady) {
                    this.$.requestResults.send(JSON.stringify(msgToSend));
                } else {
                    if (this.webSocketCounter == 0 || this.webSocketCounter
                            == undefined) {
                        this.$.requestResults.open();
                        this.webSocketCounter = 0;
                    }
                    this.webSocketCounter += 1;
                }
            },

            socketOpen: function () {
                this.webSocketReady = true;
                this._rangeChanged();
            },

            ready: function () {
                this.notMethy = true;
            },
            handleResponse: function (event) {
                var data = JSON.parse(event.detail);
                if (data == this.seqID) {
                    this.webSocketReady = false;
                    this.$.requestResults.close();
                    this.webSocketCounter -= 1;
                    return;
                }
                data.forEach(function(element) {
                    element["icon"] = "image:add-to-photos";
                });
                this.results = this.results.concat(data);
                if (this.results != null) {
                    // polymer array override dirty checking
                    this.filteredResults = this._groupByResults(this.results,
                            this.groupByMethod);
                    this.filteredResultsByType =
                            this._toTypeArray(this.filteredResults);
                    this.set("filteredResultsByType", []);
                    this.set("filteredResultsByType", this._toTypeArray(this.filteredResults));

                    this.notifyPath('filteredResultsByType');
                    getDescription(this.results);
                    this.set("_hideSpinner", true);
                }
            },

            attributeTapped: function(e) {
                console.log(e.srcElement.text);
                this.searchString = e.srcElement.text;
//                console.log($(e.srcElement).text());
            },

            itemTapped: function (e) {
                var iconElement = e.currentTarget;
                this.clicked(e.model.feedItem, iconElement);
            },

            clicked: function (result, iconElement) {
                var test_measure = result['data-source'];
                // check whether there is chart already in the main visualization.
                if (result['plot-id'] != null &&
                        document.getElementById(result['plot-id']) != null) {
                    var elementToFocus =
                            document.getElementById(result['plot-id']);
                    elementToFocus.scrollIntoView();
                    $(elementToFocus).effect("highlight", {
                        color: '#e6ecf0b'
                    }, 2000);
                    return;
                }

                // methylation charts should be customized.
                if ((result['data-type-one'] == 'methylation' &&
                        result['data-type-two'] == 'expression' ) ||
                        (result['data-type-one'] == 'expression' &&
                        result['data-type-two'] == 'methylation')) {
                    var dims = [result['data-type-one'] + '_' +
                    result['attribute-one'],
                        result['data-type-two'] + '_'
                        + result['attribute-two']];
                    var data = result['data'];

                    var elementId = this._generateId();

                    var customScatterPlot =
                            "<epiviz-json-scatter-plot class='charts' id='epiviz-"
                            + elementId + "' dim-s='" + JSON.stringify(dims) +
                            "' data='" + JSON.stringify(data) +
                            "'></epiviz-json-scatter-plot>";
                    // record the plot-id to scroll to the right position when
                    // click to add the chart, so do not create repeated charts
                    result['plot-id'] = "epiviz-" + elementId;
                    iconElement.setAttribute("id", "icon-" + result['plot-id']);
                    $("#navHeader").append(customScatterPlot);
//                    epivizScatterPlot = customScatterPlot
//                    customScatterPlot.chartSettings.title = result['title'];
                }
                // two block data, add a block overlapping track
                else if (result['data-type-one'] == 'block' &&
                        result['data-type-two'] == 'block') {
                    test_measure[0]['type'] = 'range';
                    test_measure[1]['type'] = 'range';
                    test_measure[0]['metadata'] = null;
                    test_measure[1]['metadata'] = null;
                    var block_element =
                            document.createElement('epiviz-blocks-track');
                    block_element.setAttribute('measurements',
                            JSON.stringify(test_measure));

                    block_element.className = 'charts';

                    // record the plot-id to scroll to the right position when
                    // click to add the chart, so do not create repeated charts
                    result['plot-id'] = block_element.getAttribute('plot-id');
                    iconElement.setAttribute("id", "icon-" + result['plot-id']);
                    Polymer.dom(document.getElementById("epiviz_env")).appendChild(block_element);

                    var settings =
                            JSON.parse(JSON.stringify(block_element.chartSettings));
                    settings.title = result['title'];
                    var domElem = Polymer.dom(document.getElementById("epiviz_env")).querySelector('[plot-id$="' +
                            result['plot-id'] +
                            '"]');

                    domElem.setAttribute("chart-settings",
                            JSON.stringify(settings));
                    var self = this;
                    setTimeout(function(){
                        domElem.scrollIntoView();
                        $(domElem).effect("highlight", {
                            color: '#e6ecf0b'
                        }, 1000);
                    }, 100);
                }
                else {
                    var element = document.createElement('epiviz-scatter-plot');
                    element.setAttribute('measurements',
                            JSON.stringify(test_measure));
                    element.chartSettings.title = result['title'];
                    element.className = 'charts';

                    // record the plot-id to scroll to the right position when
                    // click to add the chart, so do not create repeated charts
                    result['plot-id'] = element.getAttribute('plot-id');
                    iconElement.setAttribute("id", "icon-" + result['plot-id']);
                    Polymer.dom(document.getElementById("epiviz_env")).appendChild(element);
                    setTimeout(function(){
                        element.scrollIntoView();
                        $(element).effect("highlight", {
                            color: '#e6ecf0b'
                        }, 1000);
                    }, 100);
                }
                iconElement.setAttribute("icon", "image:collections-bookmark");
                iconElement.setAttribute("style", "color: #3284FF");
            },

            drawerToggleClicked: function() {
                var drawerLayout = document.getElementById('feed-drawer-layout');
                if (drawerLayout.forceNarrow || !drawerLayout.narrow) {
                    drawerLayout.forceNarrow = !drawerLayout.forceNarrow;
                } else {
                    drawerLayout.drawer.toggle();
                }
            },

            showHideClick: function () {
//                var element = document.getElementById('show-hide-toggle');
                var element = document.querySelector('app-drawer');
                element.toggle();
//                var feed_element = document.getElementById('feed-container');
//                if (element.textContent.trim() == "Hide") {
//                    element.textContent = "Show";
//                    feed_element.style.display = 'none';
//                } else {
//                    element.textContent = "Hide";
//                    feed_element.style.display = 'block';
//                }
            },
            searchQuery: function () {
                console.log("search executed!");
                if (this.searchString != undefined && this.searchString != null
                        && this.searchString != "") {
                    var query = this.searchString;
                    var filtered = this.results.filter(function (result) {
                        // Array.prototype.filter
                        if (result['attribute-one'].includes(query) ||
                                result['attribute-two'].includes(query) ||
                                result['computation-type'].includes(query) ||
                                result['data-type-one'].includes(query) ||
                                result['data-type-two'].includes(query) ||
                                result['value'].toString().includes(query)) {
                            return result;
                        }
                    });
//                    this.filteredResults = {};
//                    this.filteredResults["all"] = filtered;
                    this.filteredResults = this._groupByResults(filtered,
                            this.groupByMethod);
                    this.filteredResultsByType = this._toTypeArray(this.filteredResults);
                } else if (this.results != undefined) {
                    this.filteredResults = this._groupByResults(this.results,
                            this.groupByMethod);
                    this.filteredResultsByType =
                            this._toTypeArray(this.filteredResults);
                }
            },
            groupByChanged: function (e) {
                if (this.groupByMethod != undefined && this.results !=
                        undefined) {
                    var groupByType = this.groupByMethod;
//                this.groupByMethod = groupByType;
                    console.log(groupByType);
                    if (groupByType == "All") {
                        $("#trigger-All").style.visibility = 'hidden';
                    }
                    this.filteredResults = this._groupByResults(this.results,
                            groupByType);
                    this.filteredResultsByType =
                            this._toTypeArray(this.filteredResults);
                }
            },
            _groupByResults: function (resultsList, groupByType) {
                switch (groupByType) {
                    case "Computation Type":
                        var groupedResults =
                                resultsList.reduce(function (r, a) {
                                    r[a["computation-type"]] =
                                            r[a["computation-type"]] || [];
                                    r[a["computation-type"]].push(a);
                                    return r;
                                }, Object.create(null));
                        return groupedResults;
                        break;
//                    case "Tissue Type":
//                        var groupedResults =
//                                resultsList.reduce(function (r, a) {
//                                    r[a["computation-type"]] =
//                                            r[a["computation-type"]] || [];
//                                    r[a["computation-type"]].push(a);
//                                    return r;
//                                }, Object.create(null));
//                        this.filteredResults = groupedResults;
//                        this.filteredResultsByType =
//                                this._toTypeArray(this.filteredResults);
//                        break;
                    case "Data Type":
                        var groupedResults =
                                resultsList.reduce(function (r, a) {
                                    var key_one = a["data-type-one"];
                                    var key_two = a["data-type-two"];
                                    r[key_one] =
                                            r[key_one] || [];
                                    r[key_one].push(a);
                                    if (key_one != key_two) {
                                        r[key_two] = r[key_two] || [];
                                        r[key_two].push(a);
                                    }
                                    return r;
                                }, Object.create(null));
                        return groupedResults;
                        break;
                    case "All Types":
                        if (resultsList.length == 0) {
                            return [];
                        }
                        var groupedResults = {"All Computations": resultsList};
                        return groupedResults;
                    default:
                        // do nothing for now
                }
            },
            groupToggle: function (e) {
                $("#collapse-" + e.model.item.type).toggle();
            },
            _toTypeArray: function (resultsByType) {
                if (resultsByType
                        != undefined && Object.keys(resultsByType).length >
                        0) {
                    return Object.keys(resultsByType).map(function (key) {
                        if (resultsByType[key] == undefined
                                || resultsByType[key].length == 0) {
                            return;
                        }
                        return {
                            type: key,
                            list: resultsByType[key]
                        };
                    });
                } else {
                    return [];
                }
            },
            _generateId: function () {
                var text = "";
                var possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";

                for (var i = 0; i < 3; i++)
                    text += possible.charAt(Math.floor(Math.random() * possible.length));

                return text;
            },
            _getIndexClass: function (result, isSelected) {
                var classes = 'feed-element-container';
                var test_measure = result['data-source'];

                // check whether there is chart already in the main visualization.
                if ((result['plot-id'] != null &&
                        document.getElementById(result['plot-id']) != null)
                        || isSelected) {
                    classes += ' selected';
                }
                return classes;
            },
            chartDeleted: function(e) {
                var plotId = e.detail.id;
                var iconId = "icon-" + plotId;
                var feedItemElement = document.getElementById(iconId);
                feedItemElement.setAttribute("icon",
                        "image:add-to-photos");
                feedItemElement.setAttribute("style", "");
                feedItemElement.setAttribute("id", "");
            },
            _scrollIntoView: function(domElement) {
                domElement.scrollIntoView();
                $(domElement).effect("highlight", {
                    color: '#e6ecf0b'
                }, 2000);
            }
        });

        function getDescription(results) {
            results.forEach(function (result) {
                // get description
                result['description'] = result['computation-type'] +
                        ' between ' + result['data-type-one'] + ' ' +
                        result['attribute-one'] + ' and ' +
                        result['data-type-two'] + ' ' +
                        result['attribute-two'] + ' is ' +
                        result['value'].toFixed(2) + '.';
                // get title
//                result['title'] = result['computation-type'] + ' = ' +
//                        result['value'].toFixed(2) + ', p-value is ' +
//                        result['pvalue'].toFixed(2);
                result['title'] = result['computation-type'] +
                        ' between ' +
                        result['attribute-one'] + ' and ' +
                        result['attribute-two'] + ' is ' +
                        result['value'].toFixed(2);
//                result['title'] = result['computation-type'] +
//                        ' between ' + result['data-type-one'] + ' ' +
//                        result['attribute-one'] + ' and ' +
//                        result['data-type-two'] + ' ' +
//                        result['attribute-two'];
            });
        }

    </script>
</dom-module>