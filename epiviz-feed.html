<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import"
      href="bower_components/promise-polyfill/promise-polyfill-lite.html">
<link rel="import" href="bower_components/iron-list/iron-list.html">
<link rel="import" href="bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="bower_components/paper-search/paper-search-panel.html">
<link rel="import" href="bower_components/iron-collapse/iron-collapse.html">
<link rel="import"
      href="bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="bower_components/paper-item/paper-item.html">
<link rel="import" href="bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="bower_components/iron-icons/iron-icons.html">

<dom-module id="epiviz-feed">
    <template>
        <style>
            :host {
                display: inline-block;
            }

            .show-hide-button {
                padding: 10px;
                background-color: #f3f3f3;
                border: 1px solid #dedede;
                border-radius: 5px;
                font-size: 16px;
                cursor: pointer;
                -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
                text-align: center;
                display: block;
            }



            :host([opened]) #trigger {
                border-bottom-left-radius: 0;
                border-bottom-right-radius: 0;
            }

            iron-list {
                max-height: 350px;
                /* don't use % values unless the parent element is sized. */
            }

            .feed-pane-container {
                /*float: right;*/
                position: fixed;
                z-index: 100;
                right: 0;
                background: #e6ecf0;
                height: 100%;
            }

            .pane.feed-pane {
                width: 400px;
                padding: 5px;
                flex-shrink: 0;
                /*position: absolute;*/
                /*z-index: 10;*/
            }

            .pane.feed-pane:hover {
                height: 100%;
            }

            .pane.feed-pane h2 {
                color: #38425D;
                font-size: 16px;
                line-height: 20px;
                font-weight: 700;
                margin: 0 0 10px;
                display: block;
                /*-webkit-margin-before: 0.83em;*/
                /*-webkit-margin-after: 0.83em;*/
                -webkit-margin-start: 0;
                -webkit-margin-end: 0;
            }

            .pane.feed-pane h3 {
                font-size: 14px;
                display: block;
                -webkit-margin-before: 0em;
                -webkit-margin-after: 0em;
                -webkit-margin-start: 0px;
                -webkit-margin-end: 0px;
                font-weight: normal;
            }

            .open-sans-font {
                font-family: 'Open Sans', sans-serif;
            }

            .arial-sans-font {
                font-family: "Segoe UI", Arial, sans-serif;
            }

            .feed-header {

            }

            .feed-content {
                font-size: 12px;
                line-height: 18px;
                cursor: pointer;
            }

            .feed-element-container {
                background-color: #fff;
                /*border-style: groove;*/
                cursor: pointer;
                border-bottom: 2px solid #e6ecf0;
                padding: 3px;
            }

            .feed-show-hide {
                position: fixed;
                right: 10px;
                top: 10px;
                z-index: 1100;
            }

            .grouped-list {
                padding: 15px;
                border: 1px solid #dedede;
            }

            .group-dropdown-menu {
                max-width: 160px;
            }

            .overflow-y {
                overflow-y: scroll;
            }

            #feed-results {
                max-height: 500px;
            }
        </style>
        <iron-ajax id="requestResults"
                   auto
                   url="http://localhost:5001/chr=11&start=3947953&end=7164951"
                   params=''
                   handle-as="json"
                   on-response="handleResponse"
                   debounce-duration="300">
        </iron-ajax>
        <!--<button icon= "editor" id='show-hide-toggle'-->
                <!--class="feed-show-hide show-hide-button"-->
                <!--on-click="showHideClick">Hide-->
        <!--</button>-->
        <paper-button raised id='show-hide-toggle'
                      class="feed-show-hide show-hide-button"
                      on-click="showHideClick">Hide
        </paper-button>
        <div id="feed-container" class="feed-pane-container">
            <div class="pane feed-pane">
                <div class="feed-header arial-sans-font">
                    <h2><iron-icon icon="icons:trending-up"></iron-icon>
                        Feed Results
                        <paper-dropdown-menu class="group-dropdown-menu"
                                             label="GroupBy">
                            <paper-listbox class="dropdown-content"
                                           selected="{{groupByMethod}}"
                                           attr-for-selected="label"
                                           on-selected-item-changed="groupByChanged">
                                <paper-item label="All Types">All
                                    Types</paper-item>
                                <paper-item label="Tissue Type">Tissue
                                    Type</paper-item>
                                <paper-item
                                        label="Computation Type">Computation Type</paper-item>
                                <paper-item label="Data Type">Data
                                    Type</paper-item>
                            </paper-listbox>
                        </paper-dropdown-menu>
                    </h2>
                    <paper-search-panel
                            search="{{searchString}}"
                            count="5"
                            items="{{results}}"
                            hide-filter-button="True"
                            on-search="searchQuery"
                            on-search-changed="searchQuery">
                    </paper-search-panel>
                </div>
                                <div id="feed-results" class="overflow-y">

                <template is="dom-repeat"
                          items="{{filteredResultsByType}}">
                    <paper-button id="trigger trigger-[[item.type]]"
                            class="show-hide-button"
                            on-click="groupToggle"
                            aria-expanded$="[[opened]]">
                        <iron-icon icon="icons:menu"></iron-icon>
                        [[item.type]]
                    </paper-button>
                    <iron-collapse id="collapse-[[item.type]]"
                                   opened="opened">
                        <div class="grouped-list">
                            <iron-list items="[[item.list]]" as="result"
                                       selection-enabled=true
                                       selected-as="selectedItem"
                                       on-selected-item-changed="selectionChanged">
                                <template>
                                    <div class="feed-element-container">
                                        <!--<h3>[[result.description]]</h3>-->
                                        <h3>The [[result.computation-type]]
                                            between [[result.data-type-one]]
                                            <i>[[result.attribute-one]]</i> and
                                            [[result.data-type-two]]
                                            <i>[[result.attribute-two]]</i> is
                                            <b>[[result.value]]</b>. The
                                            p-value is <i>[[result.pvalue]]</i>.
                                        </h3>
                                    </div>
                                </template>
                            </iron-list>
                        </div>
                    </iron-collapse>
                </template>
                    </div>

                <!--<simple-iron-collapse class="pane feed-pane arial-sans-font"-->
                <!--filtered-results="{{filteredResults}}"-->
                <!--opened="[[opened]]"-->
                <!--search-string="[[searchString]]"></simple-iron-collapse>-->

            </div>
        </div>
        <epiviz-navigation id="epiviz_env"
                           chr="chr11"
                           start=3947953
                           end=7164991>
        </epiviz-navigation>

    </template>
    <script>
        Polymer({
            is: 'epiviz-feed',
            properties: {
                results: {
                    type: Array
                },
                filteredResults: {
                    type: Object,
                    value: {},
                    notify: true
                },
                filteredResultsByType: {
                    type: Array,
                    notify: true
                },
                selectedItem: {
                    type: Object,
                    notify: true
                },
                groupByMethod: {
                    type: String,
                    value: "All Types",
                    notify: true
                },
                searchString: {
                    type: String
                },
                opened: {
                    type: Boolean,
                    reflectToAttribute: true
                },
            },

            ready: function () {
//                this.$.requestResults.generateRequest();
                this.notMethy = true;
            },
            handleResponse: function (data) {
                this.results = data.detail.response;
                if (this.results != null) {
                    this.filteredResults = this._groupByResults(this.results,
                            this.groupByMethod);
                    this.filteredResultsByType =
                            this._toTypeArray(this.filteredResults);
                    getDescription(this.results);
                }
            },
            selectionChanged: function (e, value) {
                console.log(value);
                if (value != null && value.value != null)
                    this.clicked(value.value);
            },
            clicked: function (result) {
                var test_measure = result['data-source'];

                // check whether there is chart already in the main visualization.
                if(result['plot-id'] != null &&
                        document.getElementById(result['plot-id']) != null) {
                    var elementToFocus =
                            document.getElementById(result['plot-id']);
                    elementToFocus.scrollIntoView();
                    $(elementToFocus).effect("highlight", {color:
                            '#e6ecf0b'}, 2000);
                    return;
                }

                // methylation charts should be customized.
                if ((result['data-type-one'] == 'methylation' &&
                        result['data-type-two'] == 'expression' ) ||
                        (result['data-type-one'] == 'expression' &&
                        result['data-type-two'] == 'methylation')) {
                    var dims = [result['data-type-one'] + '_' +
                    result['attribute-one'],
                        result['data-type-two'] + '_'
                        + result['attribute-two']];
                    var data = result['data'];
                    var customScatterPlot =
                            "<epiviz-json-scatter-plot dim-s='" +
                            JSON.stringify(dims) +
                            "' data='" +
                            JSON.stringify(data) +
                            "'></epiviz-json-scatter-plot>";
                    // record the plot-id to scroll to the right position when
                    // click to add the chart, so do not create repeated charts
//                    result['plot-id'] = element.getAttribute('plot-id');

                    $("#epiviz_env").append(customScatterPlot);
//                    epivizScatterPlot = customScatterPlot
//                    customScatterPlot.chartSettings.title = result['title'];
                }
                // two block data, add a block overlapping track
                else if (result['data-type-one'] == 'block' &&
                        result['data-type-two'] == 'block') {
                    test_measure[0]['type'] = 'range';
                    test_measure[1]['type'] = 'range';
                    test_measure[0]['metadata'] = null;
                    test_measure[1]['metadata'] = null;
                    var block_element =
                            document.createElement('epiviz-blocks-track');
                    block_element.setAttribute('measurements',
                            JSON.stringify(test_measure));
                    block_element.chartSettings.title = result['title'];

                    block_element.className = 'charts';

                    // record the plot-id to scroll to the right position when
                    // click to add the chart, so do not create repeated charts
                    result['plot-id'] = block_element.getAttribute('plot-id');
                    Polymer.dom(document.querySelector("#epiviz_env")).appendChild(block_element);
                    var targetElement =
                            document.getElementById(result['plot-id']);
                    targetElement.scrollIntoView();
                    $(targetElement).effect("highlight", {color:
                            '#e6ecf0b'}, 2000);
                }
                else {
                    var element = document.createElement('epiviz-scatter-plot');
                    element.setAttribute('measurements',
                            JSON.stringify(test_measure));
                    element.chartSettings.title = result['title'];
                    element.className = 'charts';

                    // record the plot-id to scroll to the right position when
                    // click to add the chart, so do not create repeated charts
                    result['plot-id'] = element.getAttribute('plot-id');

                    Polymer.dom(document.querySelector("#epiviz_env")).appendChild(element);
                }
            },
            showHideClick: function () {
                var element = document.getElementById('show-hide-toggle');
                var feed_element = document.getElementById('feed-container');
                if (element.textContent.trim() == "Hide") {
                    element.textContent = "Show";
                    feed_element.style.display = 'none';
                } else {
                    element.textContent = "Hide";
                    feed_element.style.display = 'block';
                }
            },
            searchQuery: function () {
                console.log("search executed!");
                if (this.searchString != undefined && this.searchString != null
                        && this.searchString != "") {
                    var query = this.searchString;
                    var filtered = this.results.filter(function (result) {
                        // Array.prototype.filter
                        if (result['attribute-one'].includes(query) ||
                                result['attribute-two'].includes(query) ||
                                result['computation-type'].includes(query) ||
                                result['data-type-one'].includes(query) ||
                                result['data-type-two'].includes(query) ||
                                result['value'].toString().includes(query)) {
                            return result;
                        }
                    });
//                    this.filteredResults = {};
//                    this.filteredResults["all"] = filtered;
                    this.filteredResults = this._groupByResults(filtered,
                            this.groupByMethod);
                    this.filteredResultsByType = this._toTypeArray(this.filteredResults);
                } else if (this.results != undefined) {
                    this.filteredResults = this._groupByResults(this.results,
                            this.groupByMethod);
                    this.filteredResultsByType =
                                this._toTypeArray(this.filteredResults);
                }
            },
            groupByChanged: function (e) {
                if(this.groupByMethod != undefined && this.results !=
                        undefined) {
                    var groupByType = this.groupByMethod;
//                this.groupByMethod = groupByType;
                    console.log(groupByType);
                    if (groupByType == "All") {
                        $("#trigger-All").style.visibility = 'hidden';
                    }
                    this.filteredResults = this._groupByResults(this.results,
                            groupByType);
                    this.filteredResultsByType =
                            this._toTypeArray(this.filteredResults);
                }
            },
            _groupByResults: function (resultsList, groupByType) {
                switch (groupByType) {
                    case "Computation Type":
                        var groupedResults =
                                resultsList.reduce(function (r, a) {
                                    r[a["computation-type"]] =
                                            r[a["computation-type"]] || [];
                                    r[a["computation-type"]].push(a);
                                    return r;
                                }, Object.create(null));
                        return groupedResults;
                        break;
//                    case "Tissue Type":
//                        var groupedResults =
//                                resultsList.reduce(function (r, a) {
//                                    r[a["computation-type"]] =
//                                            r[a["computation-type"]] || [];
//                                    r[a["computation-type"]].push(a);
//                                    return r;
//                                }, Object.create(null));
//                        this.filteredResults = groupedResults;
//                        this.filteredResultsByType =
//                                this._toTypeArray(this.filteredResults);
//                        break;
                    case "Data Type":
                        var groupedResults =
                                resultsList.reduce(function (r, a) {
                                    var key_one = a["data-type-one"];
                                    var key_two = a["data-type-two"];
                                    r[key_one] =
                                            r[key_one] || [];
                                    r[key_two] = r[key_two] || [];
                                    r[key_one].push(a);
                                    r[key_two].push(a);
                                    return r;
                                }, Object.create(null));
                        return groupedResults;
                        break;
                    case "All Types":
                        if(resultsList.length == 0) {
                            return [];
                        }
                        var groupedResults = {"all": resultsList};
                        return groupedResults;
                    default:
                        // do nothing for now
                }
            },
            groupToggle: function (e) {
                $("#collapse-" + e.model.item.type).toggle();
            },
            _toTypeArray: function(resultsByType) {
            if(resultsByType
                    != undefined && Object.keys(resultsByType).length >
                    0) {
                return Object.keys(resultsByType).map(function (key) {
                    if(resultsByType[key] == undefined
                            || resultsByType[key].length == 0) {
                        return;
                    }
                    return {
                        type: key,
                        list: resultsByType[key]
                    };
                });
            } else {
                return [];
            }
        }

        });

        function getDescription(results) {
            results.forEach(function (result) {
                // get description
                result['description'] = result['computation-type'] +
                        ' between ' + result['data-type-one'] + ' ' +
                        result['attribute-one'] + ' and ' +
                        result['data-type-two'] + ' ' +
                        result['attribute-two'] + ' is ' +
                        result['value'].toFixed(2) + '.';
                // get title
                result['title'] = result['computation-type'] +
                        ' between ' + result['data-type-one'] + ' ' +
                        result['attribute-one'] + ' and ' +
                        result['data-type-two'] + ' ' +
                        result['attribute-two'];
            });
        }

    </script>
</dom-module>